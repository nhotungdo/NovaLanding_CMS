@page
@model NovaLanding.Pages.Admin.TemplatesModel
@{
    ViewData["Title"] = "Template Management";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Block Template Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
            <i class="bi bi-plus-circle"></i> Create Template
        </button>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="Hero">Hero</option>
                        <option value="Text">Text</option>
                        <option value="Image">Image</option>
                        <option value="Form">Form</option>
                        <option value="CTA">CTA</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchKeyword" placeholder="Search by name or description">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-secondary w-100" onclick="loadTemplates()">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Templates List -->
    <div id="templatesList" class="row g-4"></div>
    
    <!-- Pagination -->
    <nav class="mt-4">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<!-- Create/Edit Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Block Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <input type="hidden" id="templateId">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="templateName" required>
                    </div>
                    <div class="mb-3">
                        <label for="templateType" class="form-label">Type *</label>
                        <select class="form-select" id="templateType" required>
                            <option value="Hero">Hero</option>
                            <option value="Text">Text</option>
                            <option value="Image">Image</option>
                            <option value="Form">Form</option>
                            <option value="CTA">CTA</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="templateHtml" class="form-label">Default HTML</label>
                        <textarea class="form-control font-monospace" id="templateHtml" rows="10"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const token = localStorage.getItem('token');
        
        if (!token) {
            window.location.href = '/Auth/Login';
        }
        
        async function loadTemplates(page = 1) {
            currentPage = page;
            const type = document.getElementById('filterType').value;
            const searchKeyword = document.getElementById('searchKeyword').value;
            
            const params = new URLSearchParams({
                page: page,
                pageSize: 12,
                type: type,
                searchKeyword: searchKeyword
            });
            
            try {
                const response = await fetch(`/api/template?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                displayTemplates(data.items);
                displayPagination(data.totalPages, page);
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }
        
        function displayTemplates(templates) {
            const container = document.getElementById('templatesList');
            container.innerHTML = templates.map(t => `
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${t.name}</h5>
                            <p class="card-text"><span class="badge bg-info">${t.type}</span></p>
                            <p class="card-text text-muted">${t.description || 'No description'}</p>
                            <small class="text-muted">Created: ${new Date(t.createdAt).toLocaleDateString()}</small>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-primary" onclick="editTemplate(${t.id})">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="exportTemplate(${t.id})">Export</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayPagination(totalPages, currentPage) {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadTemplates(${i}); return false;">${i}</a>
                </li>`;
            }
            
            pagination.innerHTML = html;
        }
        
        async function saveTemplate() {
            const id = document.getElementById('templateId').value;
            const data = {
                name: document.getElementById('templateName').value,
                type: document.getElementById('templateType').value,
                description: document.getElementById('templateDescription').value,
                defaultHtml: document.getElementById('templateHtml').value
            };
            
            const url = id ? `/api/template/${id}` : '/api/template';
            const method = id ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createTemplateModal')).hide();
                    loadTemplates(currentPage);
                    document.getElementById('templateForm').reset();
                }
            } catch (error) {
                console.error('Error saving template:', error);
            }
        }
        
        async function editTemplate(id) {
            try {
                const response = await fetch(`/api/template/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const template = await response.json();
                
                document.getElementById('templateId').value = template.id;
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateType').value = template.type;
                document.getElementById('templateDescription').value = template.description || '';
                document.getElementById('templateHtml').value = template.defaultHtml || '';
                
                new bootstrap.Modal(document.getElementById('createTemplateModal')).show();
            } catch (error) {
                console.error('Error loading template:', error);
            }
        }
        
        async function deleteTemplate(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            try {
                await fetch(`/api/template/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTemplates(currentPage);
            } catch (error) {
                console.error('Error deleting template:', error);
            }
        }
        
        async function exportTemplate(id) {
            try {
                const response = await fetch(`/api/template/${id}/export`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const json = await response.text();
                
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `template-${id}.json`;
                a.click();
            } catch (error) {
                console.error('Error exporting template:', error);
            }
        }
        
        // Load templates on page load
        loadTemplates();
    </script>
}
