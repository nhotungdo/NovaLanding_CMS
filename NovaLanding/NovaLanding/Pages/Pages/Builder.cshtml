@page
@model NovaLanding.Pages.Pages.BuilderModel
@{
    ViewData["Title"] = "Page Builder";
}

<style>
    .builder-container { display: flex; height: calc(100vh - 100px); }
    .templates-panel { width: 300px; border-right: 1px solid #ddd; overflow-y: auto; padding: 15px; }
    .editor-panel { flex: 1; display: flex; flex-direction: column; }
    .editor-toolbar { padding: 15px; border-bottom: 1px solid #ddd; background: #f8f9fa; }
    .preview-panel { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
    .section-item { border: 2px dashed #ccc; padding: 15px; margin-bottom: 15px; position: relative; background: #f9f9f9; }
    .section-item.active { border-color: #0d6efd; }
    .section-controls { position: absolute; top: 5px; right: 5px; }
    .template-card { cursor: pointer; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    .template-card:hover { background: #f0f0f0; }
    .dragging { opacity: 0.5; }
</style>

<div class="builder-container">
    <!-- Templates Panel -->
    <div class="templates-panel">
        <h5>Block Templates</h5>
        <input type="text" class="form-control form-control-sm mb-3" id="templateSearch" placeholder="Search templates...">
        <div id="templatesList"></div>
    </div>
    
    <!-- Editor Panel -->
    <div class="editor-panel">
        <div class="editor-toolbar">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0" id="pageTitle">Loading...</h5>
                    <small class="text-muted" id="pageSlug"></small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-secondary" onclick="savePage()">
                        <i class="bi bi-save"></i> Save
                    </button>
                    <button class="btn btn-sm btn-success" onclick="publishPage()">
                        <i class="bi bi-check-circle"></i> Publish
                    </button>
                    <a href="/Pages" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
        
        <div class="preview-panel" id="previewPanel">
            <div class="text-center text-muted py-5">
                <i class="bi bi-plus-circle" style="font-size: 3rem;"></i>
                <p>Drag and drop templates here to start building</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Section Modal -->
<div class="modal fade" id="editSectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Section Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSectionId">
                <div class="mb-3">
                    <label class="form-label">Custom HTML/Content</label>
                    <textarea class="form-control font-monospace" id="editSectionContent" rows="15"></textarea>
                    <small class="text-muted">You can use HTML, CSS, and JavaScript here</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSection()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const pageId = urlParams.get('id');
        let currentPage = null;
        let templates = [];
        
        if (!token || !pageId) {
            window.location.href = '/Pages';
        }
        
        async function loadPage() {
            try {
                const response = await fetch(`/api/page/${pageId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                currentPage = await response.json();
                document.getElementById('pageTitle').textContent = currentPage.title;
                document.getElementById('pageSlug').textContent = `/${currentPage.slug}`;
                
                renderSections();
            } catch (error) {
                console.error('Error loading page:', error);
                alert('Failed to load page');
            }
        }
        
        async function loadTemplates() {
            try {
                const response = await fetch('/api/template?pageSize=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                templates = data.items;
                displayTemplates(templates);
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }
        
        function displayTemplates(items) {
            const container = document.getElementById('templatesList');
            container.innerHTML = items.map(t => `
                <div class="template-card" draggable="true" data-template-id="${t.id}">
                    <strong>${t.name}</strong>
                    <br><small class="text-muted">${t.type}</small>
                </div>
            `).join('');
            
            // Add drag event listeners
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
            });
        }
        
        function renderSections() {
            const panel = document.getElementById('previewPanel');
            
            if (!currentPage.sections || currentPage.sections.length === 0) {
                panel.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-plus-circle" style="font-size: 3rem;"></i>
                        <p>Drag and drop templates here to start building</p>
                    </div>`;
                return;
            }
            
            panel.innerHTML = currentPage.sections
                .sort((a, b) => a.orderNum - b.orderNum)
                .map(s => `
                    <div class="section-item ${s.isActive ? '' : 'opacity-50'}" data-section-id="${s.id}">
                        <div class="section-controls btn-group btn-group-sm">
                            <button class="btn btn-sm btn-primary" onclick="editSection(${s.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm ${s.isActive ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleSection(${s.id}, ${!s.isActive})" 
                                    title="${s.isActive ? 'Hide' : 'Show'}">
                                <i class="bi bi-eye${s.isActive ? '-slash' : ''}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSection(${s.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-info">${s.blockTemplateName}</span>
                            <span class="badge bg-secondary">${s.blockTemplateType}</span>
                        </div>
                        <div class="section-content">
                            ${s.customContent || s.defaultHtml || '<p class="text-muted">No content</p>'}
                        </div>
                    </div>
                `).join('');
            
            // Initialize Sortable for drag and drop reordering
            new Sortable(panel, {
                animation: 150,
                handle: '.section-item',
                onEnd: handleSectionReorder
            });
        }
        
        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('templateId', e.target.dataset.templateId);
            e.target.classList.add('dragging');
        }
        
        // Setup drop zone
        document.getElementById('previewPanel').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });
        
        document.getElementById('previewPanel').addEventListener('drop', async (e) => {
            e.preventDefault();
            const templateId = e.dataTransfer.getData('templateId');
            
            if (templateId) {
                await addSection(parseInt(templateId));
            }
            
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        });
        
        async function addSection(templateId) {
            try {
                const response = await fetch(`/api/page/${pageId}/sections`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ blockTemplateId: templateId })
                });
                
                if (response.ok) {
                    await loadPage();
                } else {
                    alert('Failed to add section');
                }
            } catch (error) {
                console.error('Error adding section:', error);
            }
        }
        
        function editSection(sectionId) {
            const section = currentPage.sections.find(s => s.id === sectionId);
            if (!section) return;
            
            document.getElementById('editSectionId').value = sectionId;
            document.getElementById('editSectionContent').value = section.customContent || section.defaultHtml || '';
            
            new bootstrap.Modal(document.getElementById('editSectionModal')).show();
        }
        
        async function saveSection() {
            const sectionId = document.getElementById('editSectionId').value;
            const content = document.getElementById('editSectionContent').value;
            
            try {
                const response = await fetch(`/api/page/sections/${sectionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ customContent: content })
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editSectionModal')).hide();
                    await loadPage();
                } else {
                    alert('Failed to save section');
                }
            } catch (error) {
                console.error('Error saving section:', error);
            }
        }
        
        async function toggleSection(sectionId, isActive) {
            try {
                await fetch(`/api/page/sections/${sectionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ isActive })
                });
                await loadPage();
            } catch (error) {
                console.error('Error toggling section:', error);
            }
        }
        
        async function deleteSection(sectionId) {
            if (!confirm('Delete this section?')) return;
            
            try {
                await fetch(`/api/page/sections/${sectionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                await loadPage();
            } catch (error) {
                console.error('Error deleting section:', error);
            }
        }
        
        async function handleSectionReorder(evt) {
            const sections = Array.from(document.querySelectorAll('.section-item'))
                .map((el, idx) => ({
                    sectionId: parseInt(el.dataset.sectionId),
                    orderNum: idx
                }));
            
            try {
                await fetch(`/api/page/${pageId}/sections/reorder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sections })
                });
            } catch (error) {
                console.error('Error reordering sections:', error);
            }
        }
        
        async function savePage() {
            alert('Page saved automatically!');
        }
        
        async function publishPage() {
            if (!confirm('Publish this page? You will need to unpublish before editing again.')) return;
            
            try {
                const response = await fetch(`/api/page/${pageId}/publish`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Page published successfully!');
                    window.location.href = '/Pages';
                } else {
                    const data = await response.json();
                    alert(data.message || 'Failed to publish page');
                }
            } catch (error) {
                console.error('Error publishing page:', error);
            }
        }
        
        // Template search
        document.getElementById('templateSearch').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = templates.filter(t => 
                t.name.toLowerCase().includes(keyword) || 
                t.type.toLowerCase().includes(keyword)
            );
            displayTemplates(filtered);
        });
        
        loadPage();
        loadTemplates();
    </script>
}
