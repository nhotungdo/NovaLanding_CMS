@page
@model NovaLanding.Pages.Leads.IndexModel
@{
    ViewData["Title"] = "Leads Management";
}

<div class="container-fluid mt-4">
    <h2 class="mb-4">Leads Management</h2>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Page</label>
                    <select class="form-select" id="filterPage">
                        <option value="">All Pages</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" id="fromDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" id="toDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-secondary w-100" onclick="loadLeads()">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leads Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Page</th>
                            <th>Form Data</th>
                            <th>IP Address</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr>
                            <td colspan="6" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Pagination -->
    <nav class="mt-4">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<!-- Lead Detail Modal -->
<div class="modal fade" id="leadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lead Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Page:</strong> <span id="leadPage"></span>
                </div>
                <div class="mb-3">
                    <strong>Submitted:</strong> <span id="leadDate"></span>
                </div>
                <div class="mb-3">
                    <strong>IP Address:</strong> <span id="leadIp"></span>
                </div>
                <div class="mb-3">
                    <strong>Form Data:</strong>
                    <div id="leadFormData" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteLead()">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let currentLead = null;
        const token = localStorage.getItem('token');
        
        if (!token) {
            window.location.href = '/Auth/Login';
        }
        
        async function loadPages() {
            try {
                const response = await fetch('/api/page?pageSize=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                const select = document.getElementById('filterPage');
                data.items.forEach(page => {
                    const option = document.createElement('option');
                    option.value = page.id;
                    option.textContent = page.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading pages:', error);
            }
        }
        
        async function loadLeads(page = 1) {
            currentPage = page;
            const pageId = document.getElementById('filterPage').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            const params = new URLSearchParams({
                page: page,
                pageSize: 20
            });
            
            if (pageId) params.append('pageId', pageId);
            if (fromDate) params.append('fromDate', fromDate);
            if (toDate) params.append('toDate', toDate);
            
            try {
                const response = await fetch(`/api/lead?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                displayLeads(data.items, (page - 1) * 20);
                displayPagination(data.totalPages, page);
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }
        
        function displayLeads(leads, startIndex) {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No leads found</td></tr>';
                return;
            }
            
            tbody.innerHTML = leads.map((lead, idx) => {
                const formDataPreview = Object.entries(lead.formData)
                    .slice(0, 2)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(', ');
                
                return `
                    <tr>
                        <td>${startIndex + idx + 1}</td>
                        <td>${lead.pageTitle}</td>
                        <td>${formDataPreview}${Object.keys(lead.formData).length > 2 ? '...' : ''}</td>
                        <td>${lead.ipAddress || 'N/A'}</td>
                        <td>${new Date(lead.submittedAt).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewLead(${lead.id})">
                                <i class="bi bi-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function displayPagination(totalPages, currentPage) {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadLeads(${i}); return false;">${i}</a>
                </li>`;
            }
            
            pagination.innerHTML = html;
        }
        
        async function viewLead(id) {
            try {
                const response = await fetch(`/api/lead/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                currentLead = await response.json();
                
                document.getElementById('leadPage').textContent = currentLead.pageTitle;
                document.getElementById('leadDate').textContent = new Date(currentLead.submittedAt).toLocaleString();
                document.getElementById('leadIp').textContent = currentLead.ipAddress || 'N/A';
                
                const formDataDiv = document.getElementById('leadFormData');
                formDataDiv.innerHTML = Object.entries(currentLead.formData)
                    .map(([key, value]) => `
                        <div class="mb-2">
                            <strong>${key}:</strong> ${value}
                        </div>
                    `).join('');
                
                new bootstrap.Modal(document.getElementById('leadModal')).show();
            } catch (error) {
                console.error('Error loading lead:', error);
            }
        }
        
        async function deleteLead() {
            if (!confirm('Delete this lead?')) return;
            
            try {
                await fetch(`/api/lead/${currentLead.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                bootstrap.Modal.getInstance(document.getElementById('leadModal')).hide();
                loadLeads(currentPage);
            } catch (error) {
                console.error('Error deleting lead:', error);
            }
        }
        
        loadPages();
        loadLeads();
    </script>
}
